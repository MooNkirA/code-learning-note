# 系统设计

此部分针对整个项目的系统设计，包含整个系统的架构设计，数据库表设计；系统交互时序；缓存体系设计

## 1. 建模

### 1.1. ER图

![](images/214221917220246.png)

### 1.2. 数据表

#### 1.2.1. 奖品表（card_product）

|  字段  |       类型        |   备注   |
| :---: | ---------------- | -------- |
|  id   | int(10) unsigned |          |
| name  | varchar(255)     | 奖品名称 |
|  pic  | varchar(255)     | 图片     |
| info  | varchar(1000)    | 简介     |
| price | decimal(10,2)    | 市场价   |

#### 1.2.2. 活动表（card_game）

|    字段    |       类型        |           备注           |
| :-------: | ---------------- | ------------------------ |
|    id     | int(10) unsigned |                          |
|   title   | varchar(255)     | 活动主题                  |
|   info    | varchar(1000)    | 活动简介                  |
| starttime | datetime         | 开始时间                  |
|  endtime  | datetime         | 结束时间                  |
|   type    | tinyint(2)       | 类型（1=概率类，2=随机类） |
|  status   | tinyint(1)       | 状态（0=新建，1=已加载）   |

#### 1.2.3. 会员表（card_user）

|    字段     |       类型        |   备注   |
| :--------: | ---------------- | -------- |
|     id     | int(11) unsigned |          |
|   uname    | varchar(20)      | 用户名   |
|   passwd   | varchar(50)      | 密码     |
|  realname  | varchar(10)      | 姓名     |
|   idcard   | varchar(18)      | 身份证号 |
|   phone    | varchar(15)      | 手机号码 |
|   level    | smallint(6)      | 等级     |
| createtime | datetime         | 注册时间 |
| updatetime | datetime         | 更新时间 |

#### 1.2.4. 策略表（card_game_rules）

|     字段     |       类型        |         备注          |
| :---------: | ---------------- | --------------------- |
|     id      | int(11) unsigned |                       |
|   gameid    | int(11) unsigned | 活动id                |
|  userlevel  | smallint(6)      | 会员等级               |
| enter_times | smallint(6)      | 可抽奖次数（0为不限）   |
| goal_times  | smallint(6)      | 最大中奖次数（0为不限） |

#### 1.2.5. 中奖纪录（card_user_hit）

|    字段    |       类型        |   备注   |
| :-------: | ---------------- | -------- |
|    id     | int(10) unsigned |          |
|  gameid   | int(10) unsigned | 活动id   |
|  userid   | int(10) unsigned | 用户     |
| productid | int(10) unsigned | 奖品     |
|  hittime  | datetime         | 中奖时间 |

#### 1.2.6. 奖品活动关联关系（card_game_product）

|    字段    |       类型        |  备注  |
| :-------: | ---------------- | ------ |
|    id     | int(10) unsigned |        |
|  gameid   | int(11) unsigned | 活动id |
| productid | int(11) unsigned | 奖品id |
|  amount   | smallint(6)      | 数量   |

### 1.3. 视图

#### 1.3.1. 中奖信息（view_card_user_hit）

|    字段    |       类型        |     备注      |
| :-------: | ---------------- | ------------- |
|    id     | int(10) unsigned |               |
|   title   | varchar(255)     | 活动主题       |
|   type    | varchar(100)     | 类型（值）     |
|   uname   | varchar(20)      | 用户名         |
| realname  | varchar(10)      | 姓名          |
|  idcard   | varchar(18)      | 身份证号       |
|   phone   | varchar(15)      | 手机号码       |
|   level   | varchar(100)     | 会员等级（值） |
|   name    | varchar(255)     | 奖品名称       |
|   price   | decimal(10,2)    | 市场价         |
|  gameid   | int(10) unsigned | 活动          |
|  userid   | int(10) unsigned | 用户          |
| productid | int(10) unsigned | 奖品          |
|  hittime  | datetime         | 中奖时间       |

#### 1.3.2. 奖品数统计（view_game_curinfo）

|    字段    |       类型        |    备注    |
| :-------: | ---------------- | --------- |
|    id     | int(10) unsigned |           |
|   title   | varchar(255)     | 活动主题   |
|   type    | varchar(100)     | 类型（值） |
| starttime | datetime         | 开始时间   |
|  endtime  | datetime         | 结束时间   |
|   type    | varchar(100)     | 类型（值） |
|   total   | decimal(27,0)    |           |
|    hit    | bigint(21)       |           |

## 2. 概要设计

### 2.1. 业务系统架构拓扑图

![](images/234534917246705.png)

### 2.2. 软件系统架构拓扑图

![](images/509674917239374.png)

### 2.3. 设计原则

#### 2.3.1. 动静分离

- 静态文件分离，nginx直接响应，不要再绕后台应用机器

#### 2.3.2. 微服务化

- 将模块细粒度拆分，微服务化
- 借助 docker swarm 的容器管理功能，实现不同服务的副本部署，滚动更新
- 在本项目中，api 模块就部署了3份，以适应前端的高并发

#### 2.3.3. 负载均衡

- 多个实例之间通过 nginx 做负载均衡，提升并发性能
- 本项目模块均部署在1台节点。生产环境涉及多台机器，用通过 `upstream` 配置实现。

#### 2.3.4. 异步消息

- 中奖后，中奖人及奖品信息要持久化到数据库。引入 rabbitmq，将抽奖操作与数据库操作异步隔离。
- 抽奖中奖后，只需要将中奖信息放入 rabbitmq，并立即返回中奖信息给前端用户。
- 后端 msg 模块消费 rabbitmq 消息，缓慢处理。

#### 2.3.5. 缓存预热

- 每隔 1 分钟扫描一次活动表，查询未来 1 分钟内将要开始的活动。
- 将扫到的活动加载进 redis，包括活动详细信息，中奖策略信息，奖品信息，抽奖令牌。
- 活动正式开始后，基于 redis 数据做查询，不必再与数据库打交道。

### 2.4. 交互序列图

![](images/584985117235929.png)

### 2.5. 缓存体系




## 3. 管理后台框架选型

此管理后台直接借助开源zcurd开发平台，完成后台基本的增删改查。

> zcurd 项目地址：https://gitee.com/515097842/zcurd

### 3.1. 项目初始化

【backend】 :  管理后台源码。是maven工程

1. 导入到 IDE。修改相关的配置文件
2. 创建名称为 prize 的数据库（*可修改为其他名称，但需要相应修改工程的连接数据库的相应配置文件*），导入工程 `resources/sql` 目录下的数据库脚本，初始化相关表与数据

### 3.2. 项目启动

使用 maven 命令启动项目即可

```shell
tomcat7:run
```

- 管理后台访问地址：localhost:8888 
- 账号/密码：admin/123456、zcurd/123456

## 4. 前台框架选型

【frontend】工程是接口微服务源码


## 5. 项目相关工具框架








