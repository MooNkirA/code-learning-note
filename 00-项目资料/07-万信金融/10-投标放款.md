# 第10章 投标放款

## 1. 放款业务概述

当一个标的已经筹集到了所借的全部资金，即为“满标”。此时P2P平台管理员会进行审核，审核通过后，P2P平台会把投资人的出借资金打入借款人在平台的账户中，这就叫“放款”，此时借款人贷款成功。平台放款流程如下：

![](images/254633719239480.png)

1. 管理员审核满标标的

![](images/144943819236035.png)

2. 确认审核结果

![](images/285253819231789.png)

3. 审核通过，放款成功

## 2. 投标放款需求分析

当一个标的已经筹集到了所借的全部资金，即为“满标”。此时 P2P 平台管理员会进行审核，审核通过后，P2P 平台会把投资人的出借资金打入借款人在平台的账户中，这就叫“放款”，此时就表示借款人贷款成功。

### 2.1. 系统交互流程图

系统交互流程如下图所示：

![](images/580302422220358.png)

在该业务中会新增一个还款微服务：为平台提供还款计划的生成、执行、记录与归档等功能。

### 2.2. 业务流程简述

**第一阶段：生成放款明细(图中1-2)**

1. 前端向交易中心发起满标复审通过请求
2. 交易中心汇总标的以及投标信息，形成放款明细

**第二阶段：放款(图中3-12)**

1. 交易中心请求存管代理服务进行放款操作
2. 存管代理服务对放款明细进行签名，并保存交易记录为未同步
3. 存管代理服务请求存管系统进行放款
4. 存管系统根据放款明细，将多个投资人冻结余额划至借款人账户，并更新投标信息状态为已放款
5. 返回放款结果给存管代理服务
6. 存管代理服务更新交易记录为已同步，并返回放款结果给交易中心
7. 交易中心更新所有投标信息结果为：已放款

**第三阶段：修改标的业务状态(图中13-21)**

1. 交易中心请求存管代理服务修改标的状态
2. 存管代理服务对数据进行签名，并保存交易记录为：未同步
3. 存管代理服务请求存管系统修改标的状态
4. 存管系统修改标的为状态为：已放款，并返回结果给存管代理服务
5. 存管代理服务更新交易记录为：已同步，返回修改成功给交易中心
6. 交易中心收到返回结果，修改标的状态为：还款中

**第四阶段：启动还款(图中22-25)**

1. 交易中心请求还款服务启动还款
2. 还款服务收到请求后生成还款计划和应收明细，并返回启动还款成功给交易中心
3. 交易中心返回放款成功给前端

## 3. 搭建还款微服务工程

### 3.1. 导入内容搜索微服务基础工程

导入 wanxinp2p-repayment-service 基础工程。此微服务负责还款相关的内容

### 3.2. Apollo 配置

- 在 Apollo 中创建 repayment-service 项目存储内容检索微服务工程的相关配置，关联相关公共的命名空间，并对部分项目的配置进行修改覆盖，关联清单如下：
    - micro_service.spring-boot-http 命名空间需修改，修改项如下：
        - 项目根路径：`server.servlet.context-path = /repayment`
    - micro_service.spring-eureka
    - micro_service.spring-cloud-feign
    - micro_service.spring-ribbon
    - micro_service.mybatis-plus
        - 包扫描路径：`mybatis-plus.typeAliasesPackage = com.moon.wanxinp2p.repayment.entity`
    - micro_service.spring-rocketmq
    - micro_service.spring-boot-druid
        - 数据库连接地址：`spring.datasource.url = jdbc:mysql://localhost:3306/p2p_repayment?useUnicode=true&useSSL=false`
- 修改 application 命名空间，新增相关配置，具体如下：

```properties
swagger.enable = true
spring.mvc.throw-exception-if-no-handler-found = true
```

### 3.3. 项目启动参数配置

配置以下 VM options 参数，启动服务，服务的端口是 53080

```bash
-Denv=dev -Dapollo.cluster=DEFAULT -Dserver.port=53080
```

分别启动 apollo 服务、wanxinp2p-discover-server 和 wanxinp2p-repayment-service 测试是否正常

## 4. 满标放款

### 4.1. 接口定义

> 此部分接口定义全部都在 wanxinp2p-api 工程中

#### 4.1.1. 交易中心满标放款接口

在 `TransactionApi` 接口中新增 `loansApprovalStatus` 方法

```java
/**
 * 审核标的满标放
 *
 * @param id            标的id
 * @param approveStatus 审核状态
 * @param commission    平台佣金
 * @return
 */
RestResponse<String> loansApprovalStatus(Long id, String approveStatus, String commission);
```

#### 4.1.2. 存管代理服务确认放款接口

- 在 depository 模块中，创建标的满标放款信息请求实体类和放款明细请求信息实体类

```java
@Data
public class LoanDetailRequest {
    /**
     * 放款金额
     */
    private BigDecimal amount;
    /**
     * 预处理业务流水号
     */
    private String preRequestNo;
}
```

```java
@Data
public class LoanRequest {
    /**
     * 放款明细
     */
    private List<LoanDetailRequest> details;
    /**
     * 平台佣金
     */
    private BigDecimal commission;
    /**
     * 标的编码
     */
    private String projectNo;
    /**
     * 请求流水号
     */
    private String requestNo;

    /**
     * 操作对象id
     */
    private Long id;
}
```

- 在 `DepositoryAgentApi` 接口中新增 `confirmLoan` 审核标的满标放款方法

```java
/**
 * 审核标的满标放款
 *
 * @param loanRequest
 * @return
 */
RestResponse<String> confirmLoan(LoanRequest loanRequest);
```

#### 4.1.3. 存管代理服务修改标的状态接口

- 在 transaction 模块中，创建修改标的状态DTO实体类

```java
@Data
public class ModifyProjectStatusDTO {
    /**
     * 请求流水号
     */
    private String requestNo;
    /**
     * 标的号
     */
    private String projectNo;
    /**
     * 更新标的状态
     */
    private String projectStatus;

    /**
     * 业务实体id
     */
    private Long id;
}
```

- 在 `DepositoryAgentApi` 接口中新增 `modifyProjectStatus` 修改标的状态的方法

```java
/**
 * 修改标的状态
 *
 * @param modifyProjectStatusDTO
 * @return
 */
RestResponse<String> modifyProjectStatus(ModifyProjectStatusDTO modifyProjectStatusDTO);
```

#### 4.1.4. 还款服务启动还款接口

- 在 wanxinp2p-api 工程中新建 repayment.model 包，创建标的还款信息dto类

```java
@Data
public class ProjectWithTendersDTO {
    /**
     * 标的信息
     */
    private ProjectDTO project;
    /**
     * 标的对应的所有投标记录
     */
    private List<TenderDTO> tenders;

    /**
     * 投资人让出利率 ( 投资人让利 )
     */
    private BigDecimal commissionInvestorAnnualRate;

    /**
     * 借款人给平台的利率 ( 借款人让利 )
     */
    private BigDecimal commissionBorrowerAnnualRate;
}
```

- 在 repayment 包中新建 `RepaymentApi` 接口，并定义 `startRepayment` 启动还款方法

```java
public interface RepaymentApi {
    /**
     * 启动还款
     *
     * @param projectWithTendersDTO
     * @return
     */
    RestResponse<String> startRepayment(ProjectWithTendersDTO projectWithTendersDTO);
}
```

### 4.2. 交易中心满标放款

接口功能描述

1. 接受前端满标放款信息
2. 交易中心根据标的信息生成还款明细
3. 交易中心请求存管代理服务进行满标放款
4. 交易中心收到放款成功结果后，更新投标信息状态为：已放款
5. 交易中心请求存管代理服务修改标的状态
6. 交易中心请求还款服务启动放款

#### 4.2.1. 远程调用接口

在 `DepositoryAgentApiAgent` 接口中，新增远程调用存管代理服务，确认放款与修改标的状态的方法

```java
// path 属性用于定义该接口中所有方法的请求前缀
@FeignClient(value = "depository-agent-service", path = "/depository-agent")
public interface DepositoryAgentApiAgent {
    // ....省略

    @PostMapping("/l/confirm-loan")
    RestResponse<String> confirmLoan(@RequestBody LoanRequest loanRequest);

    @PostMapping("/l/modify-project-status")
    RestResponse<String> modifyProjectStatus(@RequestBody ModifyProjectStatusDTO modifyProjectStatusDTO);
}
```

> 注：因为接口中的方法越来越多，所以使用 `@FeignClient` 注解的 `path` 来定义请求 url 的前缀，即接口中所有方法的请求 url 都会拼接上 path 所指定的前缀

#### 4.2.2. 业务层

- 修改 `ProjectService` 接口，新增 `loansApprovalStatus` 审核标的满标放款方法

```java
/**
 * 审核标的满标放款
 *
 * @param id
 * @param approveStatus
 * @param commission
 * @return String
 */
String loansApprovalStatus(Long id, String approveStatus, String commission);
```

- 在 `ProjectServiceImpl` 类中实现该方法

```java

```















### 4.3. 存管代理服务确认放款

接口功能描述

1. 接受确认放款数据
2. 保存请求记录
3. 生成签名数据
4. 请求存管系统进行确认放款


### 4.4. 存管代理服务修改标的状态

接口功能描述

1. 接受修改标的状态数据
2. 保存请求记录
3. 生成签名数据
4. 请求存管系统修改标的状态




### 4.5. 还款服务启动还款

接口功能描述

1. 接受交易中心的还款信息
2. 生成借款人还款计划，保存到数据库
3. 生成投资人应收明细，保存到数据库




### 4.6. 前后端集成测试


## 5. 分布式事务

满标放款功能涉及到分布式事务问题，需要使用 RocketMQ 事务消息实现最终一致性事务。











