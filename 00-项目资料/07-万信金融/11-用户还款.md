# 第11章 用户还款

## 1. 需求概述

满标放款审核通过后，就意味着交易已经达成。借款人以后就需要按照借款时约定的还款方式，在还款日当天将应还本息通过平台归还给投资人，此业务叫用户还款。借款人应该在临近还款日时，把应还的金额充值到平台账户中，平台在还款日当天会自动进行扣款。业务流程如下所示：

![](images/114070323239495.png)

## 2. 需求分析

用户还款一共涉及到三个服务：还款服务、存管代理服务和银行存管系统。其中银行存管系统还是像之前一样不用开发，直接使用即可。用户还款业务跟前端没有关系，由定时任务驱动业务执行，到期自动还款。

### 2.1. 业务流程图

![](images/541130423236050.png)

### 2.2. 业务流程简述

**第一阶段：生成还款明细（图中1.1-1.2）**

1. 还款服务每天定时查询到期的还款计划
2. 根据还款计划生成还款明细，状态为：未同步

**第二阶段：还款预处理（图中1.3-1.10）**

1. 还款服务通过 feign 请求存管代理服务进行还款预处理
2. 存管代理服务生成签名及数据，并保存交易记录(未同步)
3. 存管代理服务请求银行存管系统进行资金冻结
4. 银行存管系统返回预处理冻结结果给存管代理服务
5. 存管代理服务更新交易记录为：已同步，返回预处理结果给还款服务

**第三阶段：确认还款（图中2.1-2.2）**

1. 还款服务发送确认还款事务消息(半消息)
2. 还款服务执行处理本地事务：
    - 更新还款明细为：已同步
    - 更新投资人实收明细为：已收
    - 更新还款计划状态为：已还款
3. 还款服务根据本地事务执行结果发生 commit 或 rollback

**第四阶段：还款成功（图中2.3-2.9）**

1. 还款服务消费消息，并通过 feign 请求存管代理服务进行确认还款
2. 存管代理服务生成签名及数据，并保存交易记录（未同步）
3. 请求银行存管系统进行还款确定
4. 银行存管系统返回还款成功
5. 存管代理服务更新交易记录为：已同步，并返回结果给还款服务
6. 如果这个阶段处理失败，还款服务会重试消费

## 3. 第一阶段：还款服务生成还款明细

> 此部分为还款服务的功能

### 3.1. 接口定义

> 此部分接口方法全部定义在 wanxinp2p-repayment-service 还款微服务工程中

#### 3.1.1. 还款服务查询到期还款计划接口




#### 3.1.2. 还款服务生成还款明细接口

