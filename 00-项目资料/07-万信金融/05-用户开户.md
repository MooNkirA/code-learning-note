# 第05章 用户开户

## 1. 功能需求分析

开户是指借款用户和投资用户在注册后、交易前都需要在银行存管系统开通个人存管账户，在开户流程中银行存管系统是一个很重要的系统，它是当前P2P平台最常见的一种模式，为了保证资金不流向 P2P 平台，由银行存管系统去管理借款用户和投资用户的资金，P2P 平台与银行存管系统进行接口交互为借款用户和投资用户搭建交易的桥梁，它们之间的关系如下：

![](images/226412410220254.png)

借款人和投资人需要开通两个账户，一个是P2P平台的，一个是银行存管系统的。两者的账户数据需要进行同步。

### 1.1. 业务流程图

![](images/207580623238692.png)

### 1.2. 相关涉及系统介绍

- **存管系统**：不属于 P2P 平台，属于银行系统，专门负责对接 P2P 账户及交易，此系统在银行部署，P2P 平台的交易主要与存管系统交互。*由于存管系统属于银行，无需开发，直接提供源码工程。*
- **存管代理服务**：属于 P2P 平台，为了使 P2P 平台与银行存管系统松耦合，专门设立存管代理服务与存管系统对接，P2P 平台的各个服务都通过存管代理服务与银行存管系统交互。
- **开卡银行**：不属于 P2P 平台，属于银行系统，是银行用于管理储蓄卡信息的系统。为了使用方便，把该系统合并到了存管系统中。

### 1.3. 业务流程

**第一阶段：生成开户数据(图中1.1-1.8)**

1. 前端填写开户信息。前端会先查询开户信息，如果曾经填写了开户信息则在界面直接显示，用户可以修改;；如果曾经没有填写开户信息则用户在界面填写开户信息
2. 前端请求用户中心服务开户
3. 用户中心服务准备开户数据，并把开户信息保存到用户中心
4. 用户中心服务请求存管代理服务生成交易记录（未同步），并对开户数据进行签名
5. 存管代理服务将签名后的开户数据返回给用户中心
6. 用户中心将开户数据返回给前端

**第二阶段：请求开户(图中2.1-2.8)**

1. 前端携带开户信息请求银行存管系统
2. 银行存管系统向前端返回开户信息确定页面
3. 前端确认完成提交开户请求到银行存管系统
4. 银行存管系统接收开户数据并进行校验，校验银行卡信息，信息无误则将开户信息保存至存管系统（校验过程中存管系统会请求开户银行校验银行卡信息）

**第三阶段：开户结果通知(图中3.1-3.4)**

1. 开户成功后，银行存管系统异步通知存管代理服务
2. 存管代理服务接收到开户成功通知后更新交易状态为同步
3. 存管代理服务通知用户中心服务
4. 用户中心服务接收到开户成功的消息保存开户信息

## 2. 银行存管系统

由于银行存管系统不属于P2P平台，无需开发，直接提供了一个该系统源码，只需要在本地部署该系统，并熟悉它的接口信息。

### 2.1. 银行存管系统部署指南

#### 2.1.1. 数据库初始化

执行 `wanxinp2p-project\document\sql\wanxindepository-init.sql` 的脚本，初始化银行存管系统的数据库与表

#### 2.1.2. 导入项目

银行存管系统工程源码，导入 maven 工程即可



#### 2.1.3. 设置启动参数

配置以下 VM options 参数，启动服务，服务的端口是 55010

```bash
-Denv=dev -Dapollo.cluster=DEFAULT -Dserver.port=55010
```

#### 2.1.4. 项目运行测试

运行 test 包中的 BankCardServiceTest.java，进行测试

### 2.2. 银行存管系统接口说明

接口说明详见[《银行存管系统接口说明.pdf》文档](/00-项目资料/07-万信金融/attachments-万信金融/银行存管系统接口说明.pdf)



