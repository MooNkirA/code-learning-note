# 并发编程 - CAS 原子操作

## 1. CAS 概念

CAS（Compare And Swap）指比较并交换。是现代 CPU 广泛支持的一种对内存中的共享数据进行操作的一种特殊指令。CAS 操作采用了乐观锁的思想，通过比较和交换保证共享变量赋值时的原子操作，这个原子操作直接由 CPU 保证。

CAS 算法包含 V,E,N 等 3 个参数：

- V 表示要更新的变量（内存中的值）
- E 表示预期的值（旧值）
- N 表示新值

仅在 V 值等于 E 值时，才会将 V 值设为 N；如果 V 值和 E 值不同，则说明已经有其他线程做了更新，当前线程什么都不做。最后 CAS 返回当前 V 的真实值。

## 2. CAS 原理

通过刚才 `AtomicInteger` 的源码可以看到，`Unsafe` 类提供了原子操作。

### 2.1. Unsafe 类介绍

`Unsafe` 类使 Java 拥有了像 C 语言的指针一样操作内存空间的能力，同时也带来了指针的问题。过度的使用 Unsafe 类会使得出错的几率变大，因此 Java 官方并不建议使用的，官方文档也几乎没有。Unsafe 对象不能直接调用，只能通过反射获得。

![](images/231170922239684.png)

### 2.2. Unsafe 实现 CAS

![](images/399230922227551.png)

## 3. CAS 使用场景

CAS 获取共享变量时，为了保证该变量的可见性，需要使用 `volatile` 修饰。结合 CAS 和 `volatile` 可以实现无锁并发，适用于竞争不激烈、多核 CPU 的场景下。

因为没有使用 `synchronized`，所以线程不会陷入阻塞，这是效率提升的因素之一。但如果竞争激烈，可以想到重试必然频繁发生，反而效率会受影响。
